{% extends 'base.html' %}
{% load static %}

{% block title %}{{ water_body.name }} - AquaWatch{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item active">{{ water_body.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h1>{{ water_body.name }}</h1>
        <p class="lead">{{ water_body.get_water_body_type_display }}</p>
        <p>{{ water_body.description }}</p>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6>Location</h6>
                <p class="mb-1">Latitude: {{ water_body.latitude|floatformat:6 }}</p>
                <p class="mb-1">Longitude: {{ water_body.longitude|floatformat:6 }}</p>
                <h6 class="mt-3">Regulatory Body</h6>
                <p>{{ water_body.regulatory_body|default:"Not specified" }}</p>
                <h6>Monitoring Since</h6>
                <p>{{ water_body.monitoring_start_date|date:"F d, Y" }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
{% if stats %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Average pH</h6>
                <h3>{{ stats.avg_ph|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Average DO</h6>
                <h3>{{ stats.avg_do|floatformat:2 }}</h3>
                <small>mg/L</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Average Temp</h6>
                <h3>{{ stats.avg_temp|floatformat:1 }}</h3>
                <small>°C</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Average Turbidity</h6>
                <h3>{{ stats.avg_turbidity|floatformat:2 }}</h3>
                <small>NTU</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Charts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Water Quality Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="trendsChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Measurements -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Measurements</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>pH</th>
                                <th>DO (mg/L)</th>
                                <th>Temp (°C)</th>
                                <th>Turbidity (NTU)</th>
                                <th>Measured By</th>
                                <th>Alerts</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for measurement in measurements %}
                            <tr class="{% if measurement.has_alerts %}table-warning{% endif %}">
                                <td>{{ measurement.measured_at|date:"M d, Y H:i" }}</td>
                                <td>{{ measurement.ph }}</td>
                                <td>{{ measurement.dissolved_oxygen }}</td>
                                <td>{{ measurement.temperature }}</td>
                                <td>{{ measurement.turbidity }}</td>
                                <td>{{ measurement.measured_by }}</td>
                                <td>
                                    {% if measurement.has_alerts %}
                                        <span class="badge bg-warning">{{ measurement.get_alerts|length }} Alert(s)</span>
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No measurements recorded yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chartData = {{ chart_data|safe }};

const ctx = document.getElementById('trendsChart');
if (ctx && chartData.length > 0) {
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [
                {
                    label: 'pH',
                    data: chartData.map(d => d.ph),
                    borderColor: 'rgb(75, 192, 192)',
                    yAxisID: 'y',
                },
                {
                    label: 'Dissolved Oxygen (mg/L)',
                    data: chartData.map(d => d.dissolved_oxygen),
                    borderColor: 'rgb(54, 162, 235)',
                    yAxisID: 'y1',
                },
                {
                    label: 'Temperature (°C)',
                    data: chartData.map(d => d.temperature),
                    borderColor: 'rgb(255, 99, 132)',
                    yAxisID: 'y1',
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'pH'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'DO / Temperature'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}
</script>
{% endblock %}
